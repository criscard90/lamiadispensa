<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Mia Dispensa</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        #loadingScreen { position: fixed; inset: 0; z-index: 9999; background-color: #f8fafc; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s ease; }
        #authOverlay { display: none; }
        #appContent { display: none; }
        .flex-active { display: flex !important; }
        .block-active { display: block !important; }
        
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .filter-btn.active { background-color: white; color: #4f46e5; font-weight: 800; border-color: white; }
        .nav-btn { color: #cbd5e1; transition: all 0.2s; }
        .nav-btn.active { color: #4f46e5; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }

        /* FIX ORIENTAMENTO: Messaggio se ruotato */
        #portrait-lock {
            display: none;
            position: fixed;
            inset: 0;
            background: #4f46e5;
            color: white;
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        @media (orientation: landscape) {
            #portrait-lock { display: flex; }
        }

        /* SCANNER RIDOTTO */
        #scanner-container {
            max-width: 340px;
            margin: 0 auto;
            position: relative;
        }
        #reader { 
            width: 100% !important; 
            border: none !important;
            overflow: hidden;
            border-radius: 2rem;
        }
        #reader video { 
            object-fit: cover !important; 
            height: 250px !important; 
        }

        .fab-scan {
            position: fixed;
            bottom: 6rem;
            right: 1.5rem;
            width: 64px;
            height: 64px;
            background: #4f46e5;
            color: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5);
            z-index: 45;
            transition: all 0.2s;
        }
        .fab-scan:active { transform: scale(0.9); }
    </style>
</head>
<body class="pb-32">

    <div id="portrait-lock">
        <i data-lucide="rotate-cw" class="w-12 h-12 mb-4 animate-spin"></i>
        <h1 class="text-xl font-bold">Ruota il telefono</h1>
        <p class="opacity-80">L'app funziona solo in verticale</p>
    </div>
    
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p class="mt-4 text-slate-400 font-medium animate-pulse">La mia dispensa...</p>
    </div>
    
    <div id="authOverlay" class="fixed inset-0 z-[100] bg-slate-900 flex-col items-center justify-center p-6 text-center">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl max-w-sm w-full">
            <div class="w-20 h-20 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-3xl mx-auto mb-6 flex items-center justify-center text-white shadow-xl">
                <i data-lucide="refrigerator" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-black mb-3 text-slate-800">La Mia Dispensa</h2>
            <button id="loginBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 active:scale-95 transition-all">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Accedi con Google
            </button>
        </div>
    </div>
    
    <div id="appContent">
        <header class="bg-indigo-600 text-white shadow-lg sticky top-0 z-40">
            <div class="max-w-md mx-auto p-4 space-y-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <img id="user-photo" src="" class="w-9 h-9 rounded-full border-2 border-white/20 shadow-sm">
                        <h1 class="text-lg font-bold tracking-tight">Dispensa</h1>
                    </div>
                    <div class="flex gap-2">
                        <button id="logoutBtn" class="p-2 opacity-60"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                        <button onclick="openManualModal()" class="bg-indigo-500 p-2 rounded-xl active:scale-95"><i data-lucide="plus"></i></button>
                        <button onclick="toggleScanner(true)" class="bg-indigo-800 p-2 rounded-xl active:scale-95" title="Inventario Rapido">
                            <i data-lucide="layers"></i>
                        </button>
                    </div>
                </div>
                
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-indigo-300"></i>
                    <input type="text" id="search-input" oninput="handleSearch()" placeholder="Cerca prodotto..." 
                    class="w-full bg-indigo-700/50 border-none rounded-xl py-2.5 pl-10 pr-4 text-sm placeholder:text-indigo-300 focus:ring-2 focus:ring-white outline-none">
                </div>
                
                <div class="overflow-x-auto no-scrollbar flex gap-2 pb-1">
                    <button onclick="setFilter('all')" class="filter-btn active shrink-0 px-4 py-1.5 rounded-full border border-indigo-400 text-[11px] uppercase tracking-wider">Tutti</button>
                    <button onclick="setFilter('Pasta & Riso')" class="filter-btn shrink-0 px-4 py-1.5 rounded-full border border-indigo-400 text-[11px] uppercase tracking-wider">Pasta</button>
                    <button onclick="setFilter('Freschi')" class="filter-btn shrink-0 px-4 py-1.5 rounded-full border border-indigo-400 text-[11px] uppercase tracking-wider">Freschi</button>
                    <button onclick="setFilter('Conserve')" class="filter-btn shrink-0 px-4 py-1.5 rounded-full border border-indigo-400 text-[11px] uppercase tracking-wider">Conserve</button>
                    <button onclick="setFilter('Surgelati')" class="filter-btn shrink-0 px-4 py-1.5 rounded-full border border-indigo-400 text-[11px] uppercase tracking-wider">Surgelati</button>
                </div>
            </div>
        </header>
        
        <main class="max-w-md mx-auto p-4">
            <div id="scanner-container" class="hidden mb-6 bg-white p-2 rounded-[2.5rem] shadow-xl border-4 border-indigo-100">
                <div id="reader"></div>
                <div class="absolute inset-0 pointer-events-none flex items-center justify-center pb-12">
                    <div class="w-48 h-24 border-2 border-white/50 rounded-xl shadow-[0_0_0_999px_rgba(0,0,0,0.4)]"></div>
                </div>
                <button onclick="stopScanner()" class="w-full mt-2 py-2 text-red-500 font-bold text-[10px] uppercase tracking-widest">Chiudi Fotocamera</button>
            </div>
            <div id="dispensa-list" class="grid gap-3"></div>
        </main>
        
        <button onclick="toggleScanner(false)" class="fab-scan">
            <i data-lucide="scan-barcode" class="w-8 h-8"></i>
        </button>
        
        <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t p-3 flex justify-around shadow-2xl z-40">
            <button onclick="setView('all')" id="nav-all" class="nav-btn active flex flex-col items-center gap-1">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Dispensa</span>
            </button>
            <button onclick="setView('low')" id="nav-low" class="nav-btn flex flex-col items-center gap-1">
                <i data-lucide="shopping-basket" class="w-5 h-5"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Esauriti</span>
            </button>
        </nav>
    </div>
    
    <div id="manual-modal" class="modal p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h2 id="modal-title" class="text-xl font-bold mb-5">Dettaglio Prodotto</h2>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase font-black text-slate-400 ml-1">Nome</label>
                    <input type="text" id="m-nome" class="w-full border-2 border-slate-50 p-3 rounded-xl focus:border-indigo-500 outline-none bg-slate-50">
                </div>
                <div>
                    <label class="text-[10px] uppercase font-black text-slate-400 ml-1">Categoria</label>
                    <select id="m-cat" class="w-full border-2 border-slate-50 p-3 rounded-xl focus:border-indigo-500 outline-none bg-slate-50">
                        <option value="Pasta & Riso">Pasta & Riso</option>
                        <option value="Freschi">Freschi</option>
                        <option value="Conserve">Conserve</option>
                        <option value="Surgelati">Surgelati</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeManualModal()" class="flex-1 py-3 text-slate-400 font-bold text-sm">CHIUDI</button>
                <button onclick="handleSave()" class="flex-1 py-3 bg-indigo-600 text-white rounded-2xl font-bold text-sm uppercase">Salva</button>
            </div>
        </div>
    </div>
    
    <script type="module">  
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCIj-dDTISbk2hSBOxiCQvYXHV4v27qTqs",
            authDomain: "lamiadispensa-6f40f.firebaseapp.com",
            projectId: "lamiadispensa-6f40f",
            storageBucket: "lamiadispensa-6f40f.firebasestorage.app",
            messagingSenderId: "737295896450",
            appId: "1:737295896450:web:98a6166f0e5c5d6ffe499b"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let prodData = [];
        let currentFilter = 'all';
        let currentView = 'all';
        let searchQuery = '';
        let unsub = null;
        let isScanning = false;
        let isInventoryMode = false;
        let lastScannedCode = null;
        let html5QrCode;
        
        onAuthStateChanged(auth, (user) => {
            const authOverlay = document.getElementById('authOverlay');
            const appContent = document.getElementById('appContent');
            const loader = document.getElementById('loadingScreen');
            if (user) {
                currentUser = user;
                document.getElementById('user-photo').src = user.photoURL;
                authOverlay.classList.remove('flex-active');
                appContent.classList.add('block-active');
                startSync();
            } else {
                currentUser = null;
                appContent.classList.remove('block-active');
                authOverlay.classList.add('flex-active');
                if(unsub) unsub();
            }
            setTimeout(() => { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 300); }, 500);
        });
        
        function startSync() {
            const q = query(collection(db, "prodotti"), where("userId", "==", currentUser.uid));
            unsub = onSnapshot(q, (snapshot) => {
                prodData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDispensa();
            });
        }
        
        window.handleSave = async () => {
            const id = document.getElementById('edit-id').value;
            const nome = document.getElementById('m-nome').value.trim();
            const categoria = document.getElementById('m-cat').value;
            if(!nome) return;
            
            try {
                if (!id) {
                    const esistente = prodData.find(p => p.nome.toLowerCase() === nome.toLowerCase());
                    if (esistente) {
                        if (confirm(`"${nome}" esiste giÃ . Aggiungo +1?`)) await changeQty(esistente.id, 1);
                        closeManualModal(); return;
                    }
                    await addDoc(collection(db, "prodotti"), { 
                        nome, categoria, userId: currentUser.uid, qty: 1, 
                        img: 'https://cdn-icons-png.flaticon.com/512/679/679821.png', 
                        updatedAt: new Date(), barcode: null 
                    });
                } else {
                    const originale = prodData.find(p => p.id === id);
                    await updateDoc(doc(db, "prodotti", id), { 
                        nome, categoria, updatedAt: new Date() 
                    });
                }
                closeManualModal();
            } catch (e) { alert(e.message); }
        };
        
        window.changeQty = async (id, delta) => {
            const p = prodData.find(i => i.id === id);
            const newQty = Math.max(0, p.qty + delta);
            if (delta === -1 && p.qty === 0) {
                if(confirm("Eliminare?")) await deleteDoc(doc(db, "prodotti", id));
            } else {
                await updateDoc(doc(db, "prodotti", id), { qty: newQty });
            }
        };
        
        window.toggleScanner = (continuous = false) => {
            isInventoryMode = continuous;
            const container = document.getElementById('scanner-container');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                
                html5QrCode = new Html5Qrcode("reader");
                // CONFIGURAZIONE FINESTRA PICCOLA
                const config = { 
                    fps: 25, 
                    qrbox: { width: 220, height: 120 }, // Mirino rimpicciolito
                    aspectRatio: 1.0 
                };
                
                html5QrCode.start({ facingMode: "environment" }, config, async (text) => {
                    if (isScanning || (isInventoryMode && text === lastScannedCode)) return;
                    isScanning = true;
                    lastScannedCode = text;
                    if(navigator.vibrate) navigator.vibrate(80);
                    
                    if (!isInventoryMode) { stopScanner(); }
                    await window.fetchProductAPI(text);
                    isScanning = false;
                    setTimeout(() => { lastScannedCode = null; }, 2500);
                });
            } else { stopScanner(); }
        };
        
        window.stopScanner = () => {
            const container = document.getElementById('scanner-container');
            container.classList.add('hidden');
            if(html5QrCode) {
                html5QrCode.stop().then(() => html5QrCode.clear()).catch(e => console.log(e));
            }
            isScanning = false;
        };
        
        window.fetchProductAPI = async (barcode) => {
            const esistente = prodData.find(p => p.barcode === barcode);
            if (esistente) { await window.changeQty(esistente.id, 1); return; }
            
            try {
                const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await res.json();
                if (data.status === 1) {
                    const p = data.product;
                    await addDoc(collection(db, "prodotti"), {
                        userId: currentUser.uid, barcode,
                        nome: p.product_name || p.product_name_it || 'Ignoto',
                        img: p.image_url || 'https://via.placeholder.com/150',
                        categoria: 'Altro', qty: 1, updatedAt: new Date()
                    });
                } else if (!isInventoryMode) {
                    alert("Prodotto non trovato nel database."); 
                    window.openManualModal();
                }
            } catch (e) { console.error(e); }
        };
        
        window.renderDispensa = () => {
            const list = document.getElementById('dispensa-list');
            list.innerHTML = '';
            let items = [...prodData].sort((a,b) => a.nome.localeCompare(b.nome));
            if(currentView === 'low') items = items.filter(i => i.qty === 0);
            if(currentFilter !== 'all') items = items.filter(i => i.categoria === currentFilter);
            if(searchQuery) items = items.filter(i => i.nome.toLowerCase().includes(searchQuery));
            
            if(!items.length) { list.innerHTML = `<p class="text-center py-10 text-slate-300">Nessun prodotto</p>`; return; }
            
            items.forEach(p => {
                list.innerHTML += `
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                    <img src="${p.img}" class="w-16 h-16 object-cover rounded-xl bg-slate-50" onclick="openManualModal('${p.id}')">
                    <div class="flex-1 min-w-0" onclick="openManualModal('${p.id}')">
                        <h3 class="font-bold text-slate-800 text-sm truncate">${p.nome}</h3>
                        <span class="text-[9px] font-black uppercase text-indigo-500">${p.categoria}</span>
                    </div>
                    <div class="flex items-center gap-2 bg-slate-50 p-1 rounded-2xl">
                        <button onclick="changeQty('${p.id}', -1)" class="w-8 h-8 bg-white rounded-xl shadow-sm text-slate-400">-</button>
                        <span class="font-black w-6 text-center text-sm ${p.qty === 0 ? 'text-red-500' : 'text-indigo-600'}">${p.qty}</span>
                        <button onclick="changeQty('${p.id}', 1)" class="w-8 h-8 bg-indigo-600 text-white rounded-xl shadow-lg">+</button>
                    </div>
                </div>`;
            });
            lucide.createIcons();
        };
        
        window.setFilter = (cat) => { 
            currentFilter = cat; 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderDispensa(); 
        };
        window.setView = (view) => { 
            currentView = view; 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            renderDispensa(); 
        };
        window.handleSearch = () => { searchQuery = document.getElementById('search-input').value.toLowerCase(); renderDispensa(); };
        window.openManualModal = (id = null) => {
            const modal = document.getElementById('manual-modal');
            if(id) {
                const p = prodData.find(i => i.id === id);
                document.getElementById('edit-id').value = p.id;
                document.getElementById('m-nome').value = p.nome;
                document.getElementById('m-cat').value = p.categoria;
            } else {
                document.getElementById('edit-id').value = '';
                document.getElementById('m-nome').value = '';
                document.getElementById('m-cat').value = 'Altro';
            }
            modal.classList.add('active');
        };
        window.closeManualModal = () => document.getElementById('manual-modal').classList.remove('active');
        
        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logoutBtn').onclick = () => { if(confirm("Uscire?")) signOut(auth); };
        lucide.createIcons();
    </script>
</body>
</html>